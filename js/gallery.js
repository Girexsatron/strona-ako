// =========== FUNKCJE GALERII REALIZACJI ===========
// üì∏ Ten plik zawiera funkcje do obs≈Çugi galerii zdjƒôƒá naszych realizacji

document.addEventListener('DOMContentLoaded', function() {
    // Inicjalizujemy galeriƒô realizacji
    initGallery();
});

// üì∏ INICJALIZACJA I OBS≈ÅUGA GALERII
function initGallery() {
    // POPRAWKA: Najpierw sprawd≈∫my, czy jeste≈õmy na podstronie z galeriƒÖ
    // Zamiast szukaƒá konkretnego elementu .gallery-container, sprawd≈∫my czy jest klasa .gallery-page
    const isGalleryPage = document.body.classList.contains('gallery-page');
    
    // Je≈õli nie jeste≈õmy na stronie galerii, stw√≥rzmy prostƒÖ funkcjƒô przygotowawczƒÖ na potrzeby przysz≈Çej galerii
    if (!isGalleryPage) {
        // Inicjujemy podstawowe komponenty potrzebne do og√≥lnych funkcji galerii
        prepareGalleryComponents();
        return;
    }
    
    // Je≈õli jeste≈õmy na stronie galerii, znajdujemy elementy galerii
    const galleryContainer = document.querySelector('.gallery-container');
    
    // Je≈õli nie znale≈∫li≈õmy kontenera, ko≈Ñczymy
    if (!galleryContainer) {
        console.warn('‚ö†Ô∏è Nie znaleziono kontenera galerii (.gallery-container) na stronie galerii');
        return;
    }
    
    const filterButtons = document.querySelectorAll('.filter-btn');
    const galleryItems = document.querySelectorAll('.gallery-item');
    const galleryModal = document.querySelector('.gallery-modal');
    const modalImage = document.getElementById('modal-image');
    const modalTitle = document.getElementById('modal-title');
    const modalDescription = document.getElementById('modal-description');
    const modalClose = document.querySelector('.modal-close');
    
    // üîç Obs≈Çuga filtrowania
    setupFiltering(filterButtons, galleryItems);
    
    // üñºÔ∏è Obs≈Çuga powiƒôkszania zdjƒôƒá
    setupZoom(galleryItems, galleryModal, modalImage, modalTitle, modalDescription);
    
    // ‚ùå Zamykanie modalu
    setupModalClosing(galleryModal, modalClose);
    
    // üîÑ Inicjalizacja - domy≈õlnie pokazujemy wszystkie elementy
    if (filterButtons.length > 0) {
        filterButtons[0].click();
    }
    
    console.log('‚úÖ Galeria zainicjalizowana pomy≈õlnie');
}

// POPRAWKA: Dodajemy funkcjƒô do przygotowania podstawowych komponent√≥w galerii
function prepareGalleryComponents() {
    // Sprawdzamy, czy istniejƒÖ na stronie elementy z klasƒÖ .gallery-preview
    // kt√≥re mogƒÖ byƒá u≈ºywane na g≈Ç√≥wnej stronie jako zapowied≈∫ galerii
    const galleryPreviews = document.querySelectorAll('.gallery-preview');
    
    if (galleryPreviews.length === 0) {
        // Brak element√≥w galerii na tej stronie, nie robimy nic
        return;
    }
    
    // Dla ka≈ºdego podglƒÖdu galerii dodajemy obs≈Çugƒô klikniƒôcia
    galleryPreviews.forEach(preview => {
        // Dodajemy efekt przy najechaniu
        preview.addEventListener('mouseenter', function() {
            this.classList.add('hover');
        });
        
        preview.addEventListener('mouseleave', function() {
            this.classList.remove('hover');
        });
        
        // Dodajemy obs≈Çugƒô klikniƒôcia - przekierowanie do galerii
        preview.addEventListener('click', function(e) {
            // Pobieramy link do galerii z atrybutu data-gallery-url
            const galleryUrl = this.getAttribute('data-gallery-url');
            
            // Je≈õli link istnieje, przekierowujemy
            if (galleryUrl) {
                window.location.href = galleryUrl;
            } else {
                // Je≈õli nie ma linku, przekierujemy na domy≈õlnƒÖ stronƒô galerii
                window.location.href = 'gallery.html';
            }
        });
    });
    
    console.log('‚úÖ Komponenty podglƒÖdu galerii zainicjalizowane');
}

// üîç FILTROWANIE ELEMENT√ìW GALERII
function setupFiltering(filterButtons, galleryItems) {
    // Je≈õli nie ma przycisk√≥w filtrowania, ko≈Ñczymy
    if (!filterButtons || filterButtons.length === 0) return;
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Usuwamy klasƒô 'active' ze wszystkich przycisk√≥w
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // Dodajemy klasƒô 'active' do klikniƒôtego przycisku
            this.classList.add('active');
            
            // Pobieramy kategoriƒô do filtrowania
            const filterValue = this.getAttribute('data-filter');
            
            // Zapisujemy aktywnƒÖ kategoriƒô w przeglƒÖdarce (do zapamiƒôtania po od≈õwie≈ºeniu)
            localStorage.setItem('activeGalleryFilter', filterValue);
            
            // Filtrujemy elementy galerii
            filterGalleryItems(galleryItems, filterValue);
            
            // POPRAWKA: Dodajemy informacjƒô dla czytnik√≥w ekranu
            const galleryContainer = document.querySelector('.gallery-container');
            if (galleryContainer) {
                const filterName = filterValue === 'all' ? 'wszystkie realizacje' : `kategoria ${filterValue}`;
                const filterMessage = document.createElement('div');
                filterMessage.className = 'sr-only filter-message';
                filterMessage.textContent = `Filtrowanie: ${filterName}`;
                
                // Usuwamy poprzednie komunikaty
                const oldMessages = galleryContainer.querySelectorAll('.filter-message');
                oldMessages.forEach(msg => msg.remove());
                
                galleryContainer.appendChild(filterMessage);
                
                // Usuwamy komunikat po chwili (tylko wizualnie)
                setTimeout(() => {
                    filterMessage.remove();
                }, 3000);
            }
        });
    });
    
    // Sprawdzamy, czy mamy zapisanƒÖ kategoriƒô w pamiƒôci
    const savedFilter = localStorage.getItem('activeGalleryFilter');
    if (savedFilter) {
        // Znajd≈∫ przycisk z zapisanƒÖ kategoriƒÖ
        const savedButton = Array.from(filterButtons).find(
            button => button.getAttribute('data-filter') === savedFilter
        );
        
        // Je≈õli znaleziono przycisk, aktywuj go
        if (savedButton) {
            savedButton.click();
        } else {
            // Je≈õli nie znaleziono, aktywuj pierwszy
            filterButtons[0].click();
        }
    } else {
        // Domy≈õlnie aktywujemy pierwszy przycisk
        filterButtons[0].click();
    }
}

// üé≠ FILTROWANIE POSZCZEG√ìLNYCH ELEMENT√ìW
function filterGalleryItems(items, filterValue) {
    // Je≈õli nie ma element√≥w do filtrowania, ko≈Ñczymy
    if (!items || items.length === 0) return;
    
    items.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        
        // Pokazujemy wszystkie lub tylko te pasujƒÖce do filtra
        if (filterValue === 'all' || filterValue === itemCategory) {
            // POPRAWKA: Zamiast bezpo≈õrednio manipulowaƒá stylami, u≈ºywamy klas CSS
            item.classList.remove('hidden');
            // Dodajemy klasƒô 'fade-in' dla p≈Çynnej animacji pojawiania siƒô
            setTimeout(() => {
                item.classList.add('visible');
            }, 50);
        } else {
            // Ukrywamy element (najpierw usuwamy klasƒô visible dla animacji)
            item.classList.remove('visible');
            // Po zako≈Ñczeniu animacji dodajemy klasƒô 'hidden'
            setTimeout(() => {
                item.classList.add('hidden');
            }, 300); // Ten czas powinien odpowiadaƒá czasowi trwania animacji w CSS
        }
    });
}

// üñºÔ∏è POWIƒòKSZANIE ZDJƒòƒÜ
function setupZoom(galleryItems, galleryModal, modalImage, modalTitle, modalDescription) {
    // Je≈õli brakuje kt√≥rego≈õ z element√≥w, ko≈Ñczymy
    if (!galleryItems || !galleryModal || !modalImage) return;
    
    const zoomButtons = document.querySelectorAll('.gallery-zoom');
    
    zoomButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Pobieramy dane z rodzica przycisku
            const galleryItem = this.closest('.gallery-item');
            const image = galleryItem.querySelector('img');
            const title = galleryItem.querySelector('h3')?.textContent || '';
            const description = galleryItem.querySelector('p')?.textContent || '';
            
            // POPRAWKA: Pobieramy wysokiej jako≈õci wersjƒô obrazu, je≈õli istnieje
            const highResImage = image.getAttribute('data-high-res') || image.src;
            
            // Ustawiamy dane w modalu
            modalImage.src = highResImage;
            modalImage.alt = image.alt || title;
            
            // Dodajemy event listener na za≈Çadowanie obrazu
            modalImage.onload = function() {
                this.classList.add('loaded');
            };
            
            // Ustawiamy tytu≈Ç i opis, je≈õli istniejƒÖ odpowiednie elementy
            if (modalTitle) modalTitle.textContent = title;
            if (modalDescription) modalDescription.textContent = description;
            
            // Pokazujemy modal
            galleryModal.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Blokujemy przewijanie strony
            
            // POPRAWKA: Fokusujemy modal dla dostƒôpno≈õci
            galleryModal.setAttribute('tabindex', '-1');
            galleryModal.focus();
        });
    });
}

// ‚ùå ZAMYKANIE MODALU
function setupModalClosing(galleryModal, modalClose) {
    // Je≈õli nie ma modalu, ko≈Ñczymy
    if (!galleryModal) return;
    
    // Funkcja zamykajƒÖca modal
    function closeModal() {
        // POPRAWKA: Dodajemy klasƒô 'closing' dla animacji zamykania
        galleryModal.classList.add('closing');
        
        // Po zako≈Ñczeniu animacji ukrywamy modal ca≈Çkowicie
        setTimeout(() => {
            galleryModal.style.display = 'none';
            galleryModal.classList.remove('closing');
            document.body.style.overflow = 'auto'; // Przywracamy przewijanie strony
            
            // Resetujemy klasƒô animacji
            const modalImage = document.getElementById('modal-image');
            if (modalImage) {
                modalImage.classList.remove('loaded');
            }
        }, 300); // Czas odpowiadajƒÖcy animacji zamykania w CSS
    }
    
    // Zamykanie po klikniƒôciu przycisku zamkniƒôcia
    if (modalClose) {
        modalClose.addEventListener('click', function(e) {
            e.preventDefault();
            closeModal();
        });
    }
    
    // Zamykanie po klikniƒôciu poza obrazem
    galleryModal.addEventListener('click', function(e) {
        if (e.target === galleryModal) {
            closeModal();
        }
    });
    
    // Obs≈Çuga klawisza ESC do zamykania modalu
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && galleryModal && galleryModal.style.display === 'flex') {
            closeModal();
        }
    });
}

// üîÑ OD≈öWIE≈ªANIE GALERII
// Funkcja pomocnicza do wywo≈Çania po dodaniu nowych zdjƒôƒá dynamicznie
function refreshGallery() {
    // Ponownie znajdujemy wszystkie elementy
    const galleryItems = document.querySelectorAll('.gallery-item');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const galleryModal = document.querySelector('.gallery-modal');
    const modalImage = document.getElementById('modal-image');
    const modalTitle = document.getElementById('modal-title');
    const modalDescription = document.getElementById('modal-description');
    const modalClose = document.querySelector('.modal-close');
    
    // Aktualizujemy obs≈Çugƒô filtrowania
    setupFiltering(filterButtons, galleryItems);
    
    // Aktualizujemy obs≈Çugƒô powiƒôkszania
    setupZoom(galleryItems, galleryModal, modalImage, modalTitle, modalDescription);
    
    // Aktualizujemy obs≈Çugƒô zamykania modalu
    setupModalClosing(galleryModal, modalClose);
    
    console.log('üîÑ Galeria zosta≈Ça od≈õwie≈ºona');
}

// POPRAWKA: Dodajemy funkcjƒô do tworzenia podstawowego modalu galerii, je≈õli go nie ma
function createGalleryModal() {
    // Sprawdzamy, czy modal ju≈º istnieje
    let galleryModal = document.querySelector('.gallery-modal');
    
    if (!galleryModal) {
        // Tworzymy elementy modalu
        galleryModal = document.createElement('div');
        galleryModal.className = 'gallery-modal';
        galleryModal.setAttribute('tabindex', '-1');
        galleryModal.setAttribute('aria-hidden', 'true');
        galleryModal.setAttribute('role', 'dialog');
        galleryModal.setAttribute('aria-label', 'PodglƒÖd zdjƒôcia');
        
        const modalClose = document.createElement('span');
        modalClose.className = 'modal-close';
        modalClose.innerHTML = '&times;';
        modalClose.setAttribute('aria-label', 'Zamknij');
        
        const modalContent = document.createElement('div');
        modalContent.className = 'modal-content';
        
        const modalImage = document.createElement('img');
        modalImage.id = 'modal-image';
        modalImage.setAttribute('alt', '');
        
        const modalTitle = document.createElement('h3');
        modalTitle.id = 'modal-title';
        
        const modalDescription = document.createElement('p');
        modalDescription.id = 'modal-description';
        
        // Sk≈Çadamy elementy
        modalContent.appendChild(modalImage);
        modalContent.appendChild(modalTitle);
        modalContent.appendChild(modalDescription);
        
        galleryModal.appendChild(modalClose);
        galleryModal.appendChild(modalContent);
        
        // Dodajemy do body
        document.body.appendChild(galleryModal);
        
        // Konfigurujemy zamykanie
        setupModalClosing(galleryModal, modalClose);
        
        console.log('‚úÖ Utworzono nowy modal galerii');
    }
    
    return galleryModal;
}

// Eksportujemy funkcje aby by≈Çy dostƒôpne globalnie
window.refreshGallery = refreshGallery;
window.createGalleryModal = createGalleryModal;